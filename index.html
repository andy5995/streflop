<!DOCTYPE html>
<html lang="en">
<head>
<title>STandalone REproducible FLOating-Point library</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="alternate" hreflang="fr" href="../../../fr/programmation/streflop/index.html" />
<link rel="stylesheet" type="text/css" href="../../../common.css" />
<link rel="alternate stylesheet" type="text/css" href="../../../whiteBlue.css" title="White" />
<link rel="alternate stylesheet" type="text/css" href="../../../black.css" title="Black" />
<link type="text/css" href="../../../jquery.mmenu.all.css" rel="stylesheet" />
<script type="text/javascript" src="../../../jquery-1.11.2.min.js"></script>
<script type="text/javascript" src="../../../jquery.mmenu.min.all.js"></script>
<script src="../../../fonctions.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
$(document).ready(function(){
    if ($("#menudiv").css("float")!="left") setMenu();
});
//-->
</script>
<style type="text/css">
<!--
div.section { width:31.3%; }
ul.toplist {list-style-position:inside; padding-left:0px;}
ul.toplist li {margin-bottom:1em;}
#confgrid {width:100%;}
-->
</style>
</head>
<body>
<div id="front">
<div id="topPart">
<div class="decovideh0"></div>
<div id="nbspNic">&nbsp;&nbsp;&nbsp;Nic<span id="olasBrodu">olas Brodu&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div><div class="decovideh1"></div><div id="mainSectionNbsp">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div id="mainSection">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S T R E F L O P 
</div>
</div>
<div id="deco" class="FixedTop">
<a id="topMenuMobile" href="#themenu"><span></span></a>
<div id="namebk">Nicolas<br/>Brodu</div><div id="mobtitle">S T R E F L O P </div>
<div class="deco1a"></div><div class="deco1b"></div>
<div class="decovide"></div>
<div class="decoplein"></div>
<div class="decovide"></div>
<div class="deco2a"></div><div class="deco2b"></div>
<div class="decovide"></div>
<div class="decoplein"></div>
<div class="decovide"></div>
<div class="deco3a"></div><div class="deco3b"></div>
</div>
<div id="mainPartContainer">
<div id="menudiv">
<nav id="themenu">
<ul>
<li><img src="../../../bullet_right.png" alt="" /> <a href="../../../en/index.html">Welcome</a></li>
<li><img src="../../../bullet_right.png" alt="" /> <a href="../../../en/recherche/index.html">Research</a><ul class="hideul">
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/recherche/concaust/index.html">Continuous Causal States</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/recherche/superres/index.html">Super-resolution of multispectral images</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/recherche/stochadiff/index.html">Scale-dependent texture differences</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/recherche/canupo/index.html">LiDAR data classification</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/recherche/m3c2/index.html">Comparison of natural scenes</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/recherche/tomorim/index.html">Refractive index matching tomography</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/recherche/granuflow/index.html">Granular flows</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/recherche/decisional_states/index.html">Decisional States</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/recherche/publications/index.html">Publications</a></li>
<li onclick="dispElt('recherche_archives','block')"><img src="../../../bullet_side.png" alt="" /> <a href="#">Archives</a><ul id="recherche_archives">
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/recherche/PhD/index.html">PhD Thesis - Complexity</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/recherche/MScR/index.html">MScR neural networks</a></li>
</ul><script type="text/javascript">
<!--
dispElt('recherche_archives','none');
//-->
</script></li>
</ul></li>
<li><img src="../../../bullet_right.png" alt="" /> <a href="../../../en/programmation/index.html">Software</a>
<ul>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/amuencha/index.html">Musical Analyzer</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/vsfplot/index.html">Vector and scalar fields plotter</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/mesincom/index.html">Incremental complexity measure</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/neighand/index.html">Spherical neighborhood queries</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/crogai/index.html">Crogai (AI and crowds simulation)</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/incremfa/index.html">Incremental Multifractal &amp; DWT</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/bepow/index.html">B&Eacute;POW keyboard</a></li>
<li onclick="dispElt('programmation_archives','block')"><img src="../../../bullet_side.png" alt="" /> <a href="#">Archives</a><ul id="programmation_archives">
<li><img src="../../../bullet_side.png" alt="" /> <a href="http://www.encours.org">Encours remote presentation</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/streflop/index.html">Standalone reproducible float-ops</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/cheapmatrix/index.html">CheapMatrix</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/libsmb/index.html">libsmb++</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/trajectories/index.html">plugin xmms</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/programmation/krashnnet/index.html">Kwin neuron network</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="http://jsynoptic.sourceforge.net">JSynoptic</a></li>
</ul><script type="text/javascript">
<!--
dispElt('programmation_archives','none');
//-->
</script></li>
</ul></li>
<li><img src="../../../bullet_right.png" alt="" /> <a href="../../../en/creation/index.html">Art and Creations</a><ul class="hideul">
<li><img src="../../../bullet_side.png" alt="" /> <a href="https://controle.global">Global Control</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/creation/totorigami/index.html">Totoro Origami</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/creation/photos/index.html">Photo gallery</a></li>
<li><img src="../../../bullet_side.png" alt="" /> <a href="../../../en/creation/blueplanets/index.html">Blue planets</a></li>
</ul></li>
</ul>
</nav>
<div id="langageTopMenu"><a href="../../../fr/programmation/streflop/index.html">En fran&ccedil;ais <img style="width:26px;height:17px" src="../../../drapeau_francais.png" id="imglang" alt="" /></a></div>
</div>
<div id="content">
<div id="entete"></div><div class="section"><h1 class="top">Description (general)</h1>
<p>A computer has a finite memory, and cannot represent an infinity of numbers. If you add 0.1 + 0.1 in C++ you will probably not get the mathematical result 0.2. The problem is that what you get depends on many parameters. On one configuration, you may get something like 0.1995, and on another 0.1999. For the vast majority of programs, these small differences do not matter. But if you want to reproduce the same results twice, for a scientific experiment for example, on different machines or even on the same machine but with different options, then you have to be more careful. Much more careful, because these small differences can occasionally accumulate quite fast.</p>
<p>The STandalone REproducible FLOating-Point library which is the subject of this page allows you to control how the computations are done in C++. The goal is to make your programs give reliable and reproducible results.</p>

<h1>Description (detailed)</h1>
<p>Floating-point computations are strongly dependent on the FPU hardware implementation, the compiler and its optimizations, and the system mathematical library (libm). Experiments are usually reproducible only on the same machine with the same system library and the same compiler using the same options. Even then, the C++ standard does NOT guarantee reproducible results. Example:</p>
<pre>
    double x = 1.0;  x /= 10.0;
    double y = x;
    ...
    if (y == x) {
        // THIS IS NOT ALWAYS TRUE!
    }
</pre>
<p>A related but more general problem is random number generation, often necessary for experiment reproducibility:</p>
<pre>
    set_random_seed(42);
    double x = random_number();
</pre>
<p>May not return the same x across different FPUs / systems / compilers / etc.</p>
<p>These problems are related to:
<ul>
<li>Some FPU (like x87 on Linux) keep by default an internal precision (80 bits) larger than the type size in memory. In the first example, if x is on the stack but y in a register, the comparison will fail. Worse, whether x and/or y is on the stack or register depends on what you put in the ... section. This problem can be solved by restricting the internal FPU precision to the type size in memory. Unfortunately, on x87, some operations like the transcendental functions are always computed on 80 bits...</li>
<li>How well your FPU implements the IEEE754 standard, and in particular, denormal number operations. The provided arithmetic_test code reproducibly gives different results between SSE and x87. This problem is NOT generally solved by restricting the internal precision to the type size in memory. There may be relations however, in particular a denormal float may be a normal double, so the precision matters.</li>
<li>How your compiler interacts with your system math library (libm) especially with optimization flags. In particular, gcc-3.4 and gcc-4.0 series may give different results on the same system with the same library. This problem is partially solved by changing the compiler options.</li>
<li>Even then, the IEEE754 standard has some loopholes concerning NaN types. In particular, when serializing results, binary files may differ. This problem is solved by comparing the logical signification of NaNs, and not their bit patterns.</li>
</ul></p>
<p>More points to consider:
<ul>
<li>SSE has an option to accelerate computations by approximating denormals by 0. For some applications this is plain wrong, but for other applications like real-time DSP, denormals are a real pain and this is just what's needed (reports have been made that a denormal multiply may take as much as 30 times a normal multiply). Due to the default round-to-nearest mode, the denormals tend NOT to cancel to 0 and may instead accumulate. Deactivating denormals is built-in the core SSE FPU, but unfortunately that's not reproducible on x87. In that case, it's possible to check for denormal conditions after each operation (including assignment) and then flush to zero, thanks to a wrapper type. Note: This also solves the aforementionned problem of denormal non-reproducibility between x87 and SSE.</li>
<li>No external dependency. The more dependencies, the more chances of a version mismatch. This library should be standalone, providing the whole libm features without resorting to system specific includes or other packages. This way, it can be included in a project as is, with minimal specialization (and risk of misconfiguration).</li>
</ul></p>

</div><div class="section"><h1 class="top">The library</h1>
<p>Download the latest version 0.3 <a href="../../../common/programmation/streflop/streflop-0.3.tar.bz2">as a tar.bz2 package</a> or <a href="../../../common/programmation/streflop/streflop-0.3.tar.gz">as a tar.gz package</a>.</p>
<h2>Features</h2>
<ul class="toplist">
<li>Support for x87 (new and older PCs) and SSE (newer PCs only). Support for IEEE754 software implementation.</li>
<li>Support for Simple, Double and Extended types that match the native types (float, double, long double), but that additionally take care of the FPU internal precision and denormal handling. These types may be simple aliases or C++ wrappers, depending on the FPU and configuration.</li>
<li>Full set of libm functions. Not just a subset, all of them, at least for Simple and Double precisions.</li>
<li>Random number generation, using the excellent <a href="http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/emt.html">Mersenne Twister</a> created by Takuji Nishimura and Makoto Matsumoto.</li>
<li>Self-contained (no external dependencies) and easy to include in a project.</li>
<li>Support for removing denormals, even on x87. This increases the performances on SSE, but it is slow on x87 (except if you were using really a lot of denormals, in which case the wrapper cost may be less than the "no denormal" gain).</li>
<li>Goodies: C99-like functions for rounding modes and trapping NaNs, and support for software float implementation with libm. Yes, you can now run libm over softfloat, thanks to C++ wrapper types!</li>
</ul>

<h2>Configurations grid</h2>
<table id="confgrid">
<tr><td></td><td>SSE</td><td>x87</td><td>Soft</td></tr>
<tr><td>With Denormals</td><td>Simple *<br />Double *</td><td>Simple *<br />Double *<br />Extended *</td><td>Simple<br />Double<br />Extended</td></tr>
<tr><td>No Denormals</td><td>Simple *<br />Double *</td><td>Simple<br />Double<br />Extended</td><td></td></tr>
</table>
<p>One cell in this grid must be selected at configure time. All types within that cell are then available at compile and run time.<br />
Types marked * are aliases to the native float / double / long double, with support by FPU flags.<br />
The other types are wrapper classes that behave like the native types.</p>
<p>Apart for the bit representation of NaN values:
<ul>
<li>"Denormals SSE / Denormals Soft" with the same precision should give the same results.</li>
<li>"No denormal SSE / No denormal x87" with the same precision should give the same results.</li>
<li>"Denormals x87 extended / Denormals Soft extended" should give the same results.</li>
<li>"Denormals SSE / Denormals x87" with the same precision may differ but only for some unfrequent occurences involving denormal numbers.</li>
<li>All other configurations give different results.</li>
</ul></p>

<h2>Comparison criteria</h2>
<ul class="toplist">
<li>Best performance is achieved by "no denormal/SSE simple". What matters most for performance is wrapper/native, the size, then denormals or not (unless using lots of denormals, in which case "no denormals" may matter more than size or wrapper).</li>
<li>Best precision is achieved by "denormals extended" modes. What matters most for precision is the the size, then denormal or not.</li>
<li>Best IEEE754 conformance is achieved by "Soft" modes (and equivalent results above with SSE/x87). Conformance is achieved only for denormals.</li>
</ul>

</div><div class="section"><h1 class="top">Documentation</h1>
<h2>Acknowledgments</h2>
<p>This code heavily relies on <a href="http://www.gnu.org/software/libc/">GNU Libm</a>, itself depending on Sun's <a href="http://www.netlib.org/fdlibm/">netlib fdlibm</a>, GNU MP, and IBM's accurate portable mathematical library.</p>
<p>This code uses the <a href="http://www.jhauser.us/arithmetic/SoftFloat.html">SoftFloat</a> library for the software floating-point implementation.</p>
<p>The random number generator is the <a href="http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/emt.html">Mersene Twister</a>, created by Takuji Nishimura and Makoto Matsumoto, and adapted to C++ for this project. Please read the (BSD-like) license in Random.cpp if you intend to make binary packages of this library (and according to LGPL).</a>
<p>Please read the history and copyright information in the accompanying README.txt files in the libm and softfloat directories, as well as the LGPL.txt file in the main directory. Do what you want with this library, but at your own risks, and according to the LGPL (see the LGPL.txt file).</p>
<p>Thanks to Tobi Vollebregt for feedback, Win32 reports, testing, and patches, especially the rounding mode correction.</p>

<h2>Usage</h2>
<p>Include "streflop.h" in place of &lt;math.h&gt;, and link with streflop.a instead of libm. It is safe that another part of the same program uses libm, there is no risk of confusion at link time. However, including the correct file matters.</p>
<p>Use the streflop namespace, and the Simple, Double and Extended types as needed, instead of float, double, long double. The streflop types may actually be aliases to the C++ types, or wrapper classes that redefine the operators transparently (see the configurations grid)</p>
<p>You should also call streflop_init&lt;FloatType&gt; with FloatType = Simple, Double, or Extended, before using that type. You should use only this type (ex: Simple) until the next call to streflop_init. That is, separate your code in blocks using one type at a time. In the simplest case, use streflop_init for your chosen type at the beginning of your program and stick to that type later on. These init functions are necessary to set the correct FPU flags.</p>
<p>Edit Makefile.common to choose a cell in the configurations grid above. Compile, and link with streflop.a instead of libm.</p>
<p>Please read the file README.txt and the example arithmeticTest.cpp included within the source package.</p>

<h2>Notes</h2>
<p>Beware of too aggressive optimization options! In particular, since this code relies on reinterpret_cast and unions, the compiler must not assume strict aliasing. For g++ optimization levels 2 and 3, this assumption is unfortunately the default. Similarly, the compiler should not assume that NaN can be ignored, or that the FPU has a constant rounding mode. Ex: -O3 -fno-strict-aliasing -frounding-math -fsignaling-nans.</p>
<p>You should also set correct FPU options, like -mfpmath=sse -msse -msse2. The -msse2 is important, there are cases where g++ refuses to use SSE (and silently falls back to x87) when using -msse and not -msse2. This also means you cannot reliably use this library with gcc on systems where only sse (but not sse2) is present, like some athlon-xp cores.</p>
<p>The system libm will almost surely produce different numerical results depending on your FPU, compiler and options, etc. The rationale is, using this library will increase the reproducibility of your experiments compared to using the system libm, considering the denormal cases, etc. If you want guaranteed (but slower) reproducible results across all machine configurations, without caring for denormals or whatever else, then use a multiprecision software library like GNU MP. If you want to use the hardware FPU in a controlled environment that can retain some reproducibility, then use this library. If it does not fit your needs, then improve it: After all, this is free software :)</p>
<p>The following C99 trap and rounding mode functions are implemented, even for the software floating-point implementation: fe(get|set)round, fe(get|set)env, and feholdexcept. You may call them to change rounding modes and to trap special conditions. These functions are expected to work correctly, insofar as the FPU works as intended*, but they have not been extensively tested.
* in particular, reports have been made that the x87 FPU denormal trap sometimes fails.</p>
<p>There is of course the possibility of unknown bugs. And this is based on GNU libm 2.4, so any potential bug in that version are almost surely present in streflop too.</p>
<p>Extended support is incomplete. Proper functions are missing, in particular the trigonometric functions. The ldbl-96 implementation of the libm does not contain a generic implementation for these files. Since strelop enforces strict separation of Extended and Double functions, these functions were instead implemented by temporarily switching to Double using streflop_init&lt;Double&gt;, calling the function and storing the result on the stack, switching back to streflop_init&lt;Extended&gt;, then converting the result to an Extended number.</p>

</div><div id="endContent"></div>
</div>
<div id="afterContent"></div>
</div>
<div class="deco1a"></div><div class="deco1b"></div>
<div class="decovide"></div>
<div class="decoplein"></div>
<div class="decovide"></div>
<div class="deco1a"></div><div class="deco1b"></div>
<div class="decovide"></div>
<div id="footer">
<span id="myemail"><a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#110;&#105;&#99;&#111;&#108;&#97;&#115;&#x263A;&#98;&#114;&#111;&#100;&#117;&#x2600;&#110;&#101;&#116;">&#110;&#105;&#99;&#111;&#108;&#97;&#115;&#xFF20;&#98;&#114;&#111;&#100;&#117;&#46;&#110;&#101;&#116;</a></span>
<div id="maj">Last updated on 12 11 2012</div>
<!--[if IE]>
<script type="text/javascript">stopIE();</script>
<![endif]-->
</div>
<div id="styleChooser">Style: <script type="text/javascript">
<!--
var saveButtonValue = "Save";
var saveButtonTitle = "Save the style in a cookie";
createStyleForm();
//-->
</script></div>
</div>
<div id="back">
<div class="banner"><img src="../../../common/banner.png" alt="" /></div>
<div id="pageBackgroundHomePage">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S&nbsp;O&nbsp;F&nbsp;T&nbsp;W&nbsp;A&nbsp;R&nbsp;E&nbsp;</div>
<div id="pageTitleShade">S<br />T<br />R<br />E<br />F<br />L<br />O<br />P<br /></div>
<div id="pageTitle">S<br />T<br />R<br />E<br />F<br />L<br />O<br />P<br /></div>
</div>
</body>
</html>


